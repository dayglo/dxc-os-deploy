---
- hosts: all
  gather_facts: false
  connection: local

  vars:
    my_vcuser: "{{vcuser}}"
    my_vcpass: "{{vcpass}}"
    domain_suffix: .dppoc.uk
    servers_with_items:
    - name: "ocpinfranodeV{{ domain_suffix }}"
      staticip: 10.0.7.139
    - name: "ocpmasterV{{ domain_suffix }}"
      staticip: 10.0.7.141
    - name: "ocpmaster1V{{ domain_suffix }}"
      staticip: 10.0.7.140
    - name: "ocpnode1V{{ domain_suffix }}"
      staticip: 10.0.7.138
    - name: "ocpnode2V{{ domain_suffix }}"
      staticip: 10.0.7.137


#Deploy guests with tag deploy  
  tasks:
  - name: deploy guests
    tags: deploy
    with_items: "{{ servers_with_items }}"
    delegate_to: localhost
    vmware_guest:
      hostname: ukrdvmgvc001.dbpoc.uk
      validate_certs: no
      username: "{{my_vcuser}}"
      password: "{{my_vcpass}}"
      guest: "{{ item.name }}"
      template_: DXC-RHEL7.4-TEMPLATE
      datacenter: Reading-Dev
      cluster: Reading-Dev-PoC
      resource_pool: /Resources/Reading-Dev-PoC
      # datastore:  ukrd_esx_mgmt_data_002
      networks:
      - name: Container_204 
        type: static
        ip: "{{ item.staticip }}"
        netmask: 255.255.255.0
        gateway: 10.0.7.1
        dns_servers:
        - 30.5.86.7
        - 30.5.86.8
      customization:
        dns_servers:
        - 30.5.86.7
        - 30.5.86.8



#remove guests with tag remove
  - name: power off guests
    tags: remove
    with_items: "{{ servers_with_items }}"
    vmware_guest:
      hostname: ukrdvmgvc001.dbpoc.uk
      validate_certs: no
      username: "{{my_vcuser}}"
      password: "{{my_vcpass}}"
      guest: "{{ item.name }}"
      state: powered_off



  - name: remove guests
    tags: remove
    with_items: "{{ servers_with_items }}"
    vmware_guest:
      state: absent
      force: yes
      hostname: ukrdvmgvc001.dbpoc.uk
      validate_certs: no
      username: "{{my_vcuser}}"
      password: "{{my_vcpass}}"
      guest: "{{ item.name }}"
 